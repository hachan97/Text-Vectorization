Congressional leaders finalized a sweeping $1.3tn budget bill on Wednesday that substantially boosts military and domestic spending but leaves behind young immigrant Dreamers, deprives Donald Trump of some of his border wall money and takes only incremental steps to address gun violence.

As negotiators stumbled toward an end-of-the-week deadline to fund the government or face a federal shutdown, the House speaker, Paul Ryan, dashed to the White House amid concerns Trumps support was wavering. The White House later said the president backed the legislation, even as some conservative Republicans balked at the size of the spending increases and the rush to pass the bill.

Talks continued into Wednesday evening before the 2,232-page text was finally released.

No bill of this size is perfect, Ryan said. But this legislation addresses important priorities and makes us stronger at home and abroad.

Leaders still hoped to start voting as soon as Thursday. A stopgap measure may be needed to ensure federal offices are not hit with a partial shutdown at midnight on Friday when funding for the government expires.

Negotiators have been working for days and nights on details of the bill, which is widely viewed as the last major piece of legislation likely to move through Congress in this election year. Lawmakers in both parties sought to attach their top priorities.

Two of the biggest remaining issues had been border wall funds and a legislative response to gun violence after the clamor for action following recent school shootings, including the one in Parkland, Florida.

On guns, leaders agreed to tuck in bipartisan provisions to bolster school safety funds and improve compliance with the criminal background check system for firearm purchases. The bill states that the US Centers for Disease Control and Prevention can do research on gun violence, though not advocacy, an idea Democrats pushed.

But there was no resolution for Dreamers, the young immigrants who have been living in the United States illegally since childhood, but whose deportation protections are being challenged in court after Trump tried to end the Deferred Action for Childhood Arrivals program, or Daca.

Democrats temporarily shut down the government earlier this year as they fought for that protection. But the issue only rose to a discussion item when Trump made a late-hour push for a deal in exchange for $25bn in border wall funds.



Instead, Trump is now poised to win $1.6bn for barriers along the border, but none of it for the new prototypes he recently visited in California. Less than half the nearly 95 miles of border construction, including levees along the Rio Grande in Texas, would be for new barriers, with the rest for repair of existing segments. 

 In one win for immigrant advocates, negotiators rejected Trumps plans to hire hundreds of new border patrol and immigration enforcement agents.

We are disappointed that we did not reach agreement on Dreamer protections that were worthy of these patriotic young people, said Nancy Pelosi, the House minority leader.

The core purpose of the bill is to increase spending for military and domestic programs that have been sharply squeezed under a 2011 agreement that was supposed to cap spending. It gives Trump a huge budget increase for the military, while Democrats scored wins on infrastructure and other domestic programs that they failed to get under Barack Obama.

That largesse has drawn opposition from some fiscal conservatives and could make passage a potentially tricky process.

Most essential was support from Trump, who has been known to threaten to veto legislation even when his team is involved in the negotiations.

Word of Trumps discontent sent Ryan to the White House, where he was invited to a face-to-face with the president, with the Senate majority leader, Mitch McConnell, on the phone.

White House aides said the presidents support was never in doubt, but one senior White House official said the president was concerned that details of the package were not being presented as well as they could be, both to members of Congress and the public.

The group discussed how they could better sell the package, said the official, who was granted anonymity to discuss the private conversation.

The president and the leaders discussed their support for the bill, said the White House press secretary, Sarah Sanders, adding that it would fund Trump priorities such as wall construction, add money to combat the opioid crisis and provide new infrastructure spending.

Both parties touted $4.6bn in total funding to fight the nations opioid addiction epidemic, a $3bn increase. More than $2bn would go to strengthen school safety through grants for training, security measures and treatment for the mentally ill. Medical research at the National Institutes of Health, a longstanding bipartisan priority, would receive a record $3bn increase to $37bn. Funding was also included for election security ahead of the 2018 midterms.